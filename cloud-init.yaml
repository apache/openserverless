#cloud-config
apt_update: true
apt_upgrade: true
packages:
  - at

users:
  - name: ubuntu
    uid: 1000
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

write_files:
  - path: /etc/cloud-init.sh
    permissions: '0755'
    owner: root:root
    content: |
      echo "OPS_CLOUD_INIT_VER=3" >>/etc/environment
      IP="$(ip -o -4 addr | awk '$2 ~/en/ { print $4}' | cut -d/ -f1)"
      # install k3s, direnv, task
      curl -sfL https://get.k3s.io | sh -
      # set home and user
      USR="$(getent passwd 1000 | awk -F: '{print $1}')"
      HOME="/home/$USR"
      # copy authkey if there is a root one
      mkdir -p /home/$USR/.ssh
      if test -e /root/.ssh/authorized_keys
      then cat /root/.ssh/authorized_keys >>/home/$USR/.ssh/authorized_keys
      fi
      # access k3s
      mkdir -p "$HOME/.kube"
      cat /etc/rancher/k3s/k3s.yaml "$HOME/.kube/config" | sed -e 's!server: https://127.0.0.1:!server: https://'$IP':!' >"$HOME/.kube/config"
      echo "export KUBECONFIG=/home/$USR/.kube/config" >>$HOME/.bashrc
      chown -Rvf "$USR" /home/$USR
      echo "== DONE =="
  - path: /home/ubuntu/waitready
    permissions: '0755'
    owner: ubuntu:ubuntu
    defer: true
    content: |
      #!/bin/bash
      sudo cloud-init status --wait
      tail -f /tmp/cloud-init.log | while read line
      do echo "$line"
        if [[ "$line" == *"== DONE =="* ]]
        then exit 0
        fi
      done
  
  - path: /home/ubuntu/devel-init.sh
    permissions: '0755'
    defer: true
    owner: ubuntu:ubuntu
    content: |
      # task
      sudo snap install task --classic
      # install nix
      curl -L https://nixos.org/nix/install | sudo -u "$USR"  sh
      # license-eye
      cd /tmp
      curl https://dlcdn.apache.org/skywalking/eyes/0.6.0/skywalking-license-eye-0.6.0-bin.tgz | tar xzvf -
      sudo mv skywalking-license-eye-0.6.0-bin/bin/linux/license-eye /usr/bin/license-eye
      rm -Rvf skywalking-license-eye-0.6.0-bin
      curl -sfL https://direnv.net/install.sh | sudo bash
      # get openserverless sources
      cd $HOME
      git clone https://github.com/apache/openserverless.git --recurse-submodules
      # change owner to everything
      chown -Rvf "$USR" "$HOME"
      # allow direnv for submodules
      sudo -u $USR git clone https://github.com/apache/openserverless --recurse-submodules
      cd  $HOME/openserverless 
      sudo -u $USR bash sync-branch.sh
      sudo -i -H -u $USR bash "$HOME/openserverless/direnv-init.sh"
      # install license-eye and a git-hook
      sudo -u $USR git config core.hooksPath .git-hooks
 
runcmd:
  - |
    echo -e '#!/bin/bash\n/etc/cloud-init.sh 2>&1 >/tmp/cloud-init.log\n' | at now
  - |
    cd /home/ubuntu
    # add z.sh and .aliases
    curl -sL "https://raw.githubusercontent.com/rupa/z/master/z.sh" -o ".z.sh"
    curl -sL https://raw.githubusercontent.com/apache/openserverless/refs/heads/main/aliases -o ".bash_aliases"
    echo 'source $HOME/.z.sh' >> .bashrc
    # add to bashrc
    echo "source $HOME/.aliases" >>.bashrc
    chown  ubuntu:ubuntu .z.sh" .aliases .bashrc
