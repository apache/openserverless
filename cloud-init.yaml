#cloud-config
apt_update: true
apt_upgrade: true
packages:
 - at

users:
  - name: ubuntu
    uid: 1000
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

write_files:
  - path: /etc/setup.status
    permissions: '0755'
    content: |
      #!/bin/bash
      sudo cloud-init status --wait
      tail -f /tmp/setup.log | awk '/== DONE ==/ {print ; exit} {print}' 
      
runcmd:
  - |
    echo "OPS_CLOUD_INIT_VER=3" >>/etc/environment
    curl -sLo  /etc/cloud-init.sh https://raw.githubusercontent.com/sciabarracom/openserverless/main/cloud-init.sh
    chmod +x "/etc/cloud-init.sh"
    echo -e '#!/bin/bash\nsudo -iu ubuntu /etc/cloud-init.sh 2>&1 >/tmp/setup.log' | at now
 